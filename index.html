<!DOCTYPE html> 
<html style="margin:0px;"> 
<head>
	<title>Budapest Route Planner</title>
	<meta name='viewport' content='width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no' />
	<link rel="stylesheet" href="style/style.css">
	<script src='scripts/maplibre-gl/maplibre-gl.js'></script>
	<link href='scripts/maplibre-gl/maplibre-gl.css' rel='stylesheet' />
	<script type="text/javascript" charset="utf-8" src="scripts/external/turf.min.js"></script>
	<script type="text/javascript" charset="utf-8" src="scripts/gtfs.js"></script>
	<script type="text/javascript" charset="utf-8" src="scripts/style.js"></script>
	<script type="text/javascript" charset="utf-8" src="scripts/local.js"></script>
	<script type="text/javascript" charset="utf-8" src="scripts/menuControl.js"></script>
	<script type="text/javascript" charset="utf-8" src="scripts/route_ui.js"></script>
	<script>
		var map, mapUI, route;
		var gtfs, gtfsRoutes, gtfsWorker;

		function onLoad()
		{
			map = new maplibregl.Map({
				container: 'map',
				style: style,
				center: [19.06086, 47.52918],
				zoom: 15
			});
			map.addControl(new maplibregl.FullscreenControl({ container: document.querySelector('body') }));
			map.addControl(new maplibregl.NavigationControl());
			map.addControl(new maplibregl.GeolocateControl({
				positionOptions: { enableHighAccuracy: true },
				trackUserLocation: true
			}).on('geolocate', (e) => {
				console.log('geolocate', e);
			}));

			map.addControl(new MenuControl(),'top-left');

			mapUI = new MapUI(map);
			mapUI.addMarkerOnClick();

			route = new Route(mapUI);
			
			gtfsWorker = new Worker('scripts/gtfsWorker.js');
			gtfsWorker.onmessage = function(e) {
				console.log('Message from worker:',e.data);
				if(typeof e.data !== 'object' || e.data === null) return;
				if('route' in e.data) {
					console.log('got route', e.data);
					route.clearFeatures();
					for(const part of e.data.route.path) route.addFeature(part.p, {'color':part.c});
					route.commitChanges();
				}
			}
		}
	</script>
</head>
	<body onload="onLoad();"> 
		<div id="map"></div>
		<pre id="coordinates"></pre>
	</body>
</html>